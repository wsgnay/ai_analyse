spring:
  application:
    name: ffmpeg-drone-inspection

  # WebFluxé…ç½®
  codec:
    max-in-memory-size: 50MB
  webflux:
    multipart:
      max-in-memory-size: 50MB
      max-disk-usage-per-part: 100MB

  # R2DBCæ•°æ®åº“é…ç½® - ä¿®å¤MySQL 8æ—¶åŒºé—®é¢˜
  r2dbc:
    url: r2dbc:mysql://localhost:3306/drone_detection?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=Asia/Shanghai&characterEncoding=utf8&useUnicode=true
    username: root
    password: 123456
    pool:
      initial-size: 5
      max-size: 20
      max-idle-time: 30m
      validation-query: SELECT 1
      # MySQL 8 ç‰¹å®šé…ç½®
      max-acquire-time: 60s
      max-create-connection-time: 30s
      # è¿æ¥éªŒè¯
      validation-depth: LOCAL

  # Flywayæ•°æ®åº“è¿ç§»é…ç½® - ä¿®å¤MySQL 8æ—¶åŒºé—®é¢˜
  flyway:
    url: jdbc:mysql://localhost:3306/drone_detection?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=Asia/Shanghai&characterEncoding=utf8&useUnicode=true
    user: root
    password: 123456  # æ³¨æ„ï¼šè¿™é‡Œåº”è¯¥ä¸r2dbcå¯†ç ä¸€è‡´
    locations: classpath:db/migration
    baseline-on-migrate: true
    validate-on-migrate: true
    # MySQL 8 ç‰¹å®šé…ç½®
    mixed: false
    encoding: UTF-8
    sql-migration-suffixes:
      - .sql

  # Jackson JSONé…ç½®
  jackson:
    default-property-inclusion: non_null
    time-zone: Asia/Shanghai  # ä¿®æ”¹ä¸ºæ›´æ˜ç¡®çš„æ—¶åŒº
    date-format: yyyy-MM-dd HH:mm:ss
    serialization:
      write-dates-as-timestamps: false
    deserialization:
      fail-on-unknown-properties: false

# æ•°æ®åº“ç›¸å…³æ—¥å¿—é…ç½®
logging:
  level:
    root: INFO
    com.example.ffmpeg: DEBUG
    com.example.ffmpeg.service.QwenApiService: DEBUG
    com.example.ffmpeg.service.DroneImageDetectionService: DEBUG
    com.example.ffmpeg.service.DroneVideoTrackingService: DEBUG
    com.example.ffmpeg.service.DatabaseService: DEBUG
    org.springframework.web: INFO
    org.springframework.data.r2dbc: DEBUG
    io.r2dbc.mysql: DEBUG  # ä¸“é—¨ç”¨äºMySQL R2DBCè°ƒè¯•
    org.flywaydb: INFO  # Flywayæ—¥å¿—
    com.zaxxer.hikari: DEBUG  # å¦‚æœä½¿ç”¨HikariCPè¿æ¥æ± 

# é’ˆå¯¹MySQL 8çš„ä¼˜åŒ–é…ç½®
server:
  port: 8080
  # é’ˆå¯¹å¤§æ–‡ä»¶ä¸Šä¼ çš„è¶…æ—¶é…ç½®
  max-http-request-size: 500MB

# è‡ªå®šä¹‰æ•°æ®åº“é…ç½®
database:
  mysql:
    # MySQL 8 è¿æ¥å‚æ•°
    connection-properties:
      useSSL: false
      allowPublicKeyRetrieval: true
      serverTimezone: Asia/Shanghai
      characterEncoding: utf8
      useUnicode: true
      # MySQL 8 æ€§èƒ½ä¼˜åŒ–
      cachePrepStmts: true
      prepStmtCacheSize: 250
      prepStmtCacheSqlLimit: 2048
      useServerPrepStmts: true
      rewriteBatchedStatements: true

    # è¿æ¥æ± é…ç½®
    pool:
      # é€‚åˆMySQL 8çš„é…ç½®
      minimum-idle: 5
      maximum-pool-size: 20
      connection-timeout: 30000
      idle-timeout: 600000
      max-lifetime: 1800000
      leak-detection-threshold: 60000

# æ— äººæœºæ£€æµ‹ç³»ç»Ÿç‰¹å®šé…ç½®
drone:
  inspection:
    storage:
      upload-dir: "uploads"
      output-dir: "outputs"
      temp-dir: "temp"
      # æ–‡ä»¶å­˜å‚¨é…ç½®
      max-file-size: 500MB
      allowed-image-extensions:
        - jpg
        - jpeg
        - png
        - bmp
        - tiff
        - webp
      allowed-video-extensions:
        - mp4
        - avi
        - mov
        - mkv
        - flv
        - wmv

    # APIé…ç½®
    api:
      # Qwen APIé…ç½®
      qwen:
        base-url: "https://dashscope.aliyuncs.com/api/v1/services/aigc/multimodal-generation/generation"
        default-model: "qwen2.5-vl-72b-instruct"
        timeout: 120
        max-retries: 3

    # æ£€æµ‹é…ç½®
    detection:
      # é»˜è®¤ç½®ä¿¡åº¦é˜ˆå€¼
      default-confidence-threshold: 0.3
      # é»˜è®¤å›¾åƒæœ€å¤§å°ºå¯¸
      default-max-image-size: 1024
      # æ”¯æŒçš„å›¾åƒæ ¼å¼
      supported-image-formats:
        - jpg
        - jpeg
        - png
        - bmp
        - tiff
      # æ”¯æŒçš„è§†é¢‘æ ¼å¼
      supported-video-formats:
        - mp4
        - avi
        - mov
        - mkv
        - flv

    # è§†é¢‘è·Ÿè¸ªé…ç½®
    tracking:
      # é»˜è®¤è·Ÿè¸ªå™¨ç±»å‹
      default-tracker-type: "MIL"
      # æ”¯æŒçš„è·Ÿè¸ªå™¨ç±»å‹
      supported-tracker-types:
        - "MIL"
        - "CSRT"
        - "KCF"
      # æ£€æµ‹å¸§é…ç½®
      detection-frames:
        - 1
        - 60
        - 150
        - 300
      # è‡ªåŠ¨å»é‡é…ç½®
      auto-dedup:
        enabled: true
        distance-threshold: 50.0
        confidence-threshold: 0.1
streaming:
  # RTMPæ¨æµé…ç½®
  rtmp:
    # é»˜è®¤æœåŠ¡å™¨åœ°å€
    default-server: "rtmp://47.122.22.70:1935/live/"
    # å¤‡ç”¨æœåŠ¡å™¨åœ°å€åˆ—è¡¨
    backup-servers:
      - "rtmp://47.122.22.70:1935/live/"
      - "rtmp://localhost:1935/live/"
    # æ¨æµè¶…æ—¶æ—¶é—´(ç§’)
    timeout: 30
    # æ¨æµé‡è¯•æ¬¡æ•°
    max-retries: 3
    # æ¨æµç¼“å†²å¤§å°
    buffer-size: 1000

  # è§†é¢‘ç¼–ç é…ç½®
  video:
    # é»˜è®¤æ¯”ç‰¹ç‡(bps)
    default-bitrate: 2000000  # 2Mbps
    # æ¯”ç‰¹ç‡èŒƒå›´
    min-bitrate: 500000       # 500kbps
    max-bitrate: 10000000     # 10Mbps
    # é»˜è®¤å¸§ç‡
    default-framerate: 25
    # ç¼–ç å™¨é¢„è®¾
    encoder-preset: "veryfast"
    # ç¼–ç å™¨è°ƒä¼˜
    encoder-tune: "zerolatency"
    # GOPå¤§å°
    gop-size: 60

  # éŸ³é¢‘ç¼–ç é…ç½®
  audio:
    # é»˜è®¤éŸ³é¢‘æ¯”ç‰¹ç‡(bps)
    default-bitrate: 128000   # 128kbps
    # é‡‡æ ·ç‡
    sample-rate: 44100
    # å£°é“æ•°
    channels: 2

  # æ¨æµä»»åŠ¡é…ç½®
  task:
    # æœ€å¤§å¹¶å‘æ¨æµä»»åŠ¡æ•°
    max-concurrent-tasks: 10
    # ä»»åŠ¡è¶…æ—¶æ—¶é—´(åˆ†é’Ÿ)
    task-timeout: 60
    # è‡ªåŠ¨æ¸…ç†å¤±æ•ˆä»»åŠ¡çš„é—´éš”(åˆ†é’Ÿ)
    cleanup-interval: 5

# ğŸ†• æ–°å¢ï¼šç›´æ’­æµé…ç½®
livestream:
  # RTMPæœåŠ¡å™¨é…ç½®
  rtmp:
    # ä¸»æœåŠ¡å™¨
    primary:
      host: "47.122.22.70"
      port: 1935
      app: "live"
      # å®Œæ•´çš„åŸºç¡€URL: rtmp://47.122.22.70:1935/live/

    # å¤‡ç”¨æœåŠ¡å™¨é…ç½®
    backup:
      - host: "localhost"
        port: 1935
        app: "live"

  # HLSé…ç½®(å¯é€‰)
  hls:
    enabled: false
    base-url: "http://47.122.22.70:8080/hls/"
    segment-duration: 6
    segment-count: 3

  # æ¨æµè®¤è¯é…ç½®(å¯é€‰)
  auth:
    enabled: false
    # æ¨æµå¯†é’¥å‰ç¼€
    stream-key-prefix: "ai_stream_"
    # å¯†é’¥è¿‡æœŸæ—¶é—´(å°æ—¶)
    key-expiry-hours: 24
